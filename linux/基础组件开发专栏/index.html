<!DOCTYPE html>
<html><head>
<title>基础组件开发专栏</title>

<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-163347799-1', 'auto');
	
	ga('send', 'pageview');
}
</script>



<script src="/vendor/js/jquery.min.js" ></script>
<script src="/vendor/js/popper.min.js" ></script>
<script src="/vendor/js/bootstrap.min.js" ></script>
<script src="/vendor/js/smooth-scroll.polyfills.min.js" ></script>
<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
<script src="/vendor/js/vue.min.js" ></script>




<link rel="stylesheet" href="https://gongluck.github.io/scss/journal.min.47aa1ffb60880ad8c72feecd6962a14331eca7a7a30e08354a1ca91009b8bc5b.css" integrity="sha256-R6of&#43;2CICtjHL&#43;7NaWKhQzHsp6ejDgg1ShypEAm4vFs=" media="screen">



<link rel="stylesheet" href="https://gongluck.github.io/scss/dark-mode.min.b8ced257adf01d727091488aba5d273c60910773635166b513b27c1c28b9c866.css" integrity="sha256-uM7SV63wHXJwkUiKul0nPGCRB3NjUWa1E7J8HCi5yGY=" media="screen">


<script src="https://gongluck.github.io/js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons");
</script>

<script src="https://gongluck.github.io/js/table.js"></script>




<script src="https://gongluck.github.io/js/toc.js"></script>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="/vendor/js/md5.min.js"></script>
<script>
  var gitalk = new Gitalk({
  clientID: '49c0a21d9340c4049e72',
  clientSecret: '6a22a79ca072e86728e6b1385927d1ec92f3d4a8',
  repo: 'blogtalk',
  owner: 'gongluck',
  admin: ['gongluck'],
  id: md5(location.pathname),
  distractionFreeMode: 'false'
  });
  window.onload = function () {
        gitalk.render('gitalk-container')
  }
</script>






</head><body>
    	<div id="app"><div ref="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://gongluck.github.io">
    
        <div class="nav-title">
            gongluck&#39;s blog
        </div>
        
        <div class="nav-subtitle">
            C/C&#43;&#43; Golang 音视频流媒体
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                Categories
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                Tags
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="https://www.cnblogs.com/gongluck/">
                CNBLOG
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="https://blog.csdn.net/gongluck93">
                CSDN
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="https://github.com/gongluck">
                Github
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS Feed
            </a>
            
        
    </div>

    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> 
    <span id="busuanzi_container_page_pv">本文总阅读量<span id="busuanzi_value_page_pv"></span>次</span>
    <span id="busuanzi_container_site_uv">本站访客数<span id="busuanzi_value_site_uv"></span>人次</span>
    <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2024 gongluck&#39;s blog
	
    </div>
    
</div><div ref="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e4%b8%89%e5%9f%ba%e7%a1%80%e7%bb%84%e4%bb%b6%e5%bc%80%e5%8f%91%e4%b8%93%e6%a0%8f" v-on:click="closeDrawer" id="三基础组件开发专栏-nav">
										 三、基础组件开发专栏
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#0%e9%a1%b9%e7%9b%ae%e4%bb%93%e5%ba%93" v-on:click="closeDrawer" id="0项目仓库-nav">
										 0.项目仓库
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#1%e7%ba%bf%e7%a8%8b%e6%b1%a0%e5%8e%9f%e7%90%86%e4%b8%8e%e5%ae%9e%e7%8e%b0" v-on:click="closeDrawer" id="1线程池原理与实现-nav">
										 1.线程池原理与实现
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#11-%e7%ba%bf%e7%a8%8b%e6%b1%a0%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b" v-on:click="closeDrawer" id="11-线程池工作流程-nav">
										 1.1 线程池工作流程
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#12-%e7%ba%bf%e7%a8%8b%e6%b1%a0%e5%ae%9e%e7%8e%b0" v-on:click="closeDrawer" id="12-线程池实现-nav">
										 1.2 线程池实现
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#2cas%e5%92%8c%e6%97%a0%e9%94%81%e9%98%9f%e5%88%97" v-on:click="closeDrawer" id="2cas和无锁队列-nav">
										 2.CAS和无锁队列
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#21-cas" v-on:click="closeDrawer" id="21-cas-nav">
										 2.1 CAS
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#22-%e6%97%a0%e9%94%81%e9%98%9f%e5%88%97" v-on:click="closeDrawer" id="22-无锁队列-nav">
										 2.2 无锁队列
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#3%e5%86%85%e5%ad%98%e6%b1%a0" v-on:click="closeDrawer" id="3内存池-nav">
										 3.内存池
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#31-nginx%e5%86%85%e5%ad%98%e6%b1%a0%e7%bb%93%e6%9e%84" v-on:click="closeDrawer" id="31-nginx内存池结构-nav">
										 3.1 Nginx内存池结构
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#32-nginx%e5%86%85%e5%ad%98%e6%b1%a0%e7%9a%84%e5%ae%9e%e7%8e%b0httpsgithubcomgongluckcvipblobmastercodemmpoolngx_pallocc" v-on:click="closeDrawer" id="32-nginx内存池的实现httpsgithubcomgongluckcvipblobmastercodemmpoolngx_pallocc-nav">
										 3.2 Nginx内存池的实现
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a class="pagination-action" v-on:click="toggleDarkMode">
            <i class="material-icons pagination-action-icon" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons pagination-action-icon" v-else="isDarkMode">
                brightness_7
            </i>
        </a>
        
        
    </div>
</div><div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    Tags
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="https://www.cnblogs.com/gongluck/">
                    CNBLOG
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="https://blog.csdn.net/gongluck93">
                    CSDN
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="https://github.com/gongluck">
                    Github
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS Feed
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e4%b8%89%e5%9f%ba%e7%a1%80%e7%bb%84%e4%bb%b6%e5%bc%80%e5%8f%91%e4%b8%93%e6%a0%8f" v-on:click="closeDrawer" id="三基础组件开发专栏-nav">
										 三、基础组件开发专栏
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#0%e9%a1%b9%e7%9b%ae%e4%bb%93%e5%ba%93" v-on:click="closeDrawer" id="0项目仓库-nav">
										 0.项目仓库
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#1%e7%ba%bf%e7%a8%8b%e6%b1%a0%e5%8e%9f%e7%90%86%e4%b8%8e%e5%ae%9e%e7%8e%b0" v-on:click="closeDrawer" id="1线程池原理与实现-nav">
										 1.线程池原理与实现
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#11-%e7%ba%bf%e7%a8%8b%e6%b1%a0%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b" v-on:click="closeDrawer" id="11-线程池工作流程-nav">
										 1.1 线程池工作流程
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#12-%e7%ba%bf%e7%a8%8b%e6%b1%a0%e5%ae%9e%e7%8e%b0" v-on:click="closeDrawer" id="12-线程池实现-nav">
										 1.2 线程池实现
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#2cas%e5%92%8c%e6%97%a0%e9%94%81%e9%98%9f%e5%88%97" v-on:click="closeDrawer" id="2cas和无锁队列-nav">
										 2.CAS和无锁队列
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#21-cas" v-on:click="closeDrawer" id="21-cas-nav">
										 2.1 CAS
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#22-%e6%97%a0%e9%94%81%e9%98%9f%e5%88%97" v-on:click="closeDrawer" id="22-无锁队列-nav">
										 2.2 无锁队列
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#3%e5%86%85%e5%ad%98%e6%b1%a0" v-on:click="closeDrawer" id="3内存池-nav">
										 3.内存池
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#31-nginx%e5%86%85%e5%ad%98%e6%b1%a0%e7%bb%93%e6%9e%84" v-on:click="closeDrawer" id="31-nginx内存池结构-nav">
										 3.1 Nginx内存池结构
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#32-nginx%e5%86%85%e5%ad%98%e6%b1%a0%e7%9a%84%e5%ae%9e%e7%8e%b0httpsgithubcomgongluckcvipblobmastercodemmpoolngx_pallocc" v-on:click="closeDrawer" id="32-nginx内存池的实现httpsgithubcomgongluckcvipblobmastercodemmpoolngx_pallocc-nav">
										 3.2 Nginx内存池的实现
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="https://gongluck.github.io">
            gongluck&#39;s blog
        </a>
        
        <button type="button" class="nav-darkmode-toggle" v-on:click="toggleDarkMode">
            <i class="material-icons" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons" v-else="isDarkMode">
                brightness_7
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://gongluck.github.io">
        <div class="single-column-header-title">gongluck&#39;s blog</div>
        
        <div class="single-column-header-subtitle">C/C&#43;&#43; Golang 音视频流媒体</div>
        

    </a>
</div>
            <div id="content">
<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            
                
            

            <div class="post-head-wrapper"
                
                    
                    
                    style="background-image: url('https://gongluck.github.io/img/linux_wh.jpg')"
                    
                
            >
                <div class="post-title">
                    基础组件开发专栏
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2020-11-30 20:58
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/linux">linux</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/linux">linux</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                <div class="post-body">
                    <h2 id="三基础组件开发专栏">三、基础组件开发专栏</h2>
<h3 id="0项目仓库">0.项目仓库</h3>
<ul>
<li><a href="https://github.com/gongluck/CVIP.git">https://github.com/gongluck/CVIP.git</a></li>
</ul>
<h3 id="1线程池原理与实现">1.线程池原理与实现</h3>
<h4 id="11-线程池工作流程">1.1 线程池工作流程</h4>
<p><img src="https://github.com/gongluck/CVIP/blob/master/images/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png?raw=true" alt="线程池工作流程"></p>
<h4 id="12-线程池实现">1.2 线程池实现</h4>
<ul>
<li>
<p><a href="https://github.com/gongluck/CVIP/blob/master/code/threadpool/threadpool.c">线程池实现代码</a></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&lt;pthread.h&gt;</span><span style="color:#1e889b">
</span><span style="color:#1e889b"></span>  
<span style="color:#228b22">// 添加队列节点
</span><span style="color:#228b22"></span><span style="color:#1e889b">#define LL_ADD(item, list) \
</span><span style="color:#1e889b">    do                     \
</span><span style="color:#1e889b">    {                      \
</span><span style="color:#1e889b">        item-&gt;prev = NULL; \
</span><span style="color:#1e889b">        item-&gt;next = list; \
</span><span style="color:#1e889b">        list = item;       \
</span><span style="color:#1e889b">    } while (0)
</span><span style="color:#1e889b"></span>  
<span style="color:#228b22">// 移除队列节点
</span><span style="color:#228b22"></span><span style="color:#1e889b">#define LL_REMOVE(item, list)              \
</span><span style="color:#1e889b">    do                                     \
</span><span style="color:#1e889b">    {                                      \
</span><span style="color:#1e889b">        if (item-&gt;prev != NULL)            \
</span><span style="color:#1e889b">            item-&gt;prev-&gt;next = item-&gt;next; \
</span><span style="color:#1e889b">        if (item-&gt;next != NULL)            \
</span><span style="color:#1e889b">            item-&gt;next-&gt;prev = item-&gt;prev; \
</span><span style="color:#1e889b">        if (list == item)                  \
</span><span style="color:#1e889b">            list = item-&gt;next;             \
</span><span style="color:#1e889b">        item-&gt;prev = item-&gt;next = NULL;    \
</span><span style="color:#1e889b">    } while (0)
</span><span style="color:#1e889b"></span>  
<span style="color:#228b22">// 工作线程
</span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">typedef</span> <span style="color:#8b008b;font-weight:bold">struct</span> WORKER
{
    pthread_t <span style="color:#8b008b;font-weight:bold">thread</span>;
    <span style="color:#00688b;font-weight:bold">int</span> terminate;
    <span style="color:#8b008b;font-weight:bold">struct</span> WORKQUEUE *workqueue;
    <span style="color:#8b008b;font-weight:bold">struct</span> WORKER *prev;
    <span style="color:#8b008b;font-weight:bold">struct</span> WORKER *next;
} Worker;
  
<span style="color:#228b22">// 工作任务
</span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">typedef</span> <span style="color:#8b008b;font-weight:bold">struct</span> JOB
{
    <span style="color:#00688b;font-weight:bold">void</span> (*job_function)(<span style="color:#8b008b;font-weight:bold">struct</span> JOB *job);
    <span style="color:#00688b;font-weight:bold">void</span> *user_data;
    <span style="color:#8b008b;font-weight:bold">struct</span> JOB *prev;
    <span style="color:#8b008b;font-weight:bold">struct</span> JOB *next;
} Job;
  
<span style="color:#228b22">// 工作调度
</span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">typedef</span> <span style="color:#8b008b;font-weight:bold">struct</span> WORKQUEUE
{
    <span style="color:#8b008b;font-weight:bold">struct</span> WORKER *workers;
    <span style="color:#8b008b;font-weight:bold">struct</span> JOB *waiting_jobs;
    pthread_mutex_t jobs_mtx;
    pthread_cond_t jobs_cond;
} WorkQueue;
  
<span style="color:#8b008b;font-weight:bold">typedef</span> WorkQueue ThreadPool;
  
<span style="color:#228b22">// 工作线程回调函数
</span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">void</span> *<span style="color:#008b45">WorkerThread</span>(<span style="color:#00688b;font-weight:bold">void</span> *ptr)
{
    Worker *worker = (Worker *)ptr;
  
    <span style="color:#8b008b;font-weight:bold">while</span> (<span style="color:#b452cd">1</span>)
    {
        pthread_mutex_lock(&amp;worker-&gt;workqueue-&gt;jobs_mtx);
  
        <span style="color:#8b008b;font-weight:bold">while</span> (worker-&gt;workqueue-&gt;waiting_jobs == <span style="color:#658b00">NULL</span>)
        {
            <span style="color:#8b008b;font-weight:bold">if</span> (worker-&gt;terminate)
                <span style="color:#8b008b;font-weight:bold">break</span>;
            pthread_cond_wait(&amp;worker-&gt;workqueue-&gt;jobs_cond, &amp;worker-&gt;workqueue-&gt;jobs_mtx);
        }
  
        <span style="color:#8b008b;font-weight:bold">if</span> (worker-&gt;terminate)
        {
            pthread_mutex_unlock(&amp;worker-&gt;workqueue-&gt;jobs_mtx);
            <span style="color:#8b008b;font-weight:bold">break</span>;
        }
  
        Job *job = worker-&gt;workqueue-&gt;waiting_jobs;
        <span style="color:#8b008b;font-weight:bold">if</span> (job != <span style="color:#658b00">NULL</span>)
        {
            LL_REMOVE(job, worker-&gt;workqueue-&gt;waiting_jobs);
        }
  
        pthread_mutex_unlock(&amp;worker-&gt;workqueue-&gt;jobs_mtx);
  
        <span style="color:#8b008b;font-weight:bold">if</span> (job == <span style="color:#658b00">NULL</span>)
            <span style="color:#8b008b;font-weight:bold">continue</span>;
  
        job-&gt;job_function(job);
    }
  
    free(worker);
    pthread_exit(<span style="color:#658b00">NULL</span>);
}
  
<span style="color:#228b22">// 创建线程池
</span><span style="color:#228b22"></span><span style="color:#00688b;font-weight:bold">int</span> <span style="color:#008b45">ThreadPoolCreate</span>(ThreadPool *workqueue, <span style="color:#00688b;font-weight:bold">int</span> numWorkers)
{
    <span style="color:#8b008b;font-weight:bold">if</span> (numWorkers &lt; <span style="color:#b452cd">1</span>)
        numWorkers = <span style="color:#b452cd">1</span>;
    memset(workqueue, <span style="color:#b452cd">0</span>, <span style="color:#8b008b;font-weight:bold">sizeof</span>(ThreadPool));
  
    pthread_mutex_init(&amp;workqueue-&gt;jobs_mtx, <span style="color:#658b00">NULL</span>);
    pthread_cond_init(&amp;workqueue-&gt;jobs_cond, <span style="color:#658b00">NULL</span>);
  
    <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#00688b;font-weight:bold">int</span> i = <span style="color:#b452cd">0</span>; i &lt; numWorkers; i++)
    {
        Worker *worker = (Worker *)malloc(<span style="color:#8b008b;font-weight:bold">sizeof</span>(Worker));
        <span style="color:#8b008b;font-weight:bold">if</span> (worker == <span style="color:#658b00">NULL</span>)
        {
            perror(<span style="color:#cd5555">&#34;malloc&#34;</span>);
            <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">1</span>;
        }
  
        memset(worker, <span style="color:#b452cd">0</span>, <span style="color:#8b008b;font-weight:bold">sizeof</span>(Worker));
        worker-&gt;workqueue = workqueue;
  
        <span style="color:#00688b;font-weight:bold">int</span> ret = pthread_create(&amp;worker-&gt;<span style="color:#8b008b;font-weight:bold">thread</span>, <span style="color:#658b00">NULL</span>, WorkerThread, (<span style="color:#00688b;font-weight:bold">void</span> *)worker);
        <span style="color:#8b008b;font-weight:bold">if</span> (ret)
        {
            perror(<span style="color:#cd5555">&#34;pthread_create&#34;</span>);
            free(worker);
            <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">1</span>;
        }
  
        LL_ADD(worker, worker-&gt;workqueue-&gt;workers);
    }
  
    <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">0</span>;
}
  
<span style="color:#228b22">// 终止线程池
</span><span style="color:#228b22"></span><span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">ThreadPoolShutdown</span>(ThreadPool *workqueue)
{
    <span style="color:#8b008b;font-weight:bold">for</span> (Worker *worker = workqueue-&gt;workers; worker != <span style="color:#658b00">NULL</span>; worker = worker-&gt;next)
    {
        worker-&gt;terminate = <span style="color:#b452cd">1</span>;
    }
  
    pthread_mutex_lock(&amp;workqueue-&gt;jobs_mtx);
  
    workqueue-&gt;workers = <span style="color:#658b00">NULL</span>;
    workqueue-&gt;waiting_jobs = <span style="color:#658b00">NULL</span>;
  
    pthread_cond_broadcast(&amp;workqueue-&gt;jobs_cond);
  
    pthread_mutex_unlock(&amp;workqueue-&gt;jobs_mtx);
}
  
<span style="color:#228b22">// 添加任务
</span><span style="color:#228b22"></span><span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">ThreadPoolQueue</span>(ThreadPool *workqueue, Job *job)
{
    pthread_mutex_lock(&amp;workqueue-&gt;jobs_mtx);
  
    LL_ADD(job, workqueue-&gt;waiting_jobs);
  
    pthread_cond_signal(&amp;workqueue-&gt;jobs_cond);
    pthread_mutex_unlock(&amp;workqueue-&gt;jobs_mtx);
}
</code></pre></div><!-- raw HTML omitted -->
</li>
</ul>
<h3 id="2cas和无锁队列">2.CAS和无锁队列</h3>
<h4 id="21-cas">2.1 CAS</h4>
<ul>
<li>
<p>比较并交换（compare and swap，CAS），是<strong>原⼦操作</strong>的⼀种，可⽤于在多线程编程中实现不被打断的数据交换操作，从而避免多线程同时改写某⼀数据时由于执行顺序不确定性以及中断的不可预知性产⽣的数据不一致问题有了CAS，我们就可以用它来实现各种无锁（lock free）的数据结构。</p>
</li>
<li>
<p>该操作通过将内存中的值与指定数据进行比较，当数值⼀样时将内存中的数据替换为新的值。</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#00688b;font-weight:bold">int</span> <span style="color:#008b45">compare_and_swap</span>(<span style="color:#00688b;font-weight:bold">int</span> *reg, <span style="color:#00688b;font-weight:bold">int</span> oldval, <span style="color:#00688b;font-weight:bold">int</span> newval)
{
    <span style="color:#00688b;font-weight:bold">int</span> old_ref_val = *reg;
    <span style="color:#8b008b;font-weight:bold">if</span>(old_reg_val == oldval)<span style="color:#228b22">//compare
</span><span style="color:#228b22"></span>        *reg = newval;<span style="color:#228b22">//swap
</span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">return</span> old_reg_val;
}
</code></pre></div></li>
<li>
<p>gcc/g++中的CAS</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#00688b;font-weight:bold">bool</span> <span style="color:#008b45">__sync_bool_compare_and_swap</span>(type *ptr, type oldval type newval, ...);
type <span style="color:#008b45">__sync_val_compare_and_swap</span>(type *ptr, type oldval type newval, ...);
</code></pre></div></li>
<li>
<p>Windows的CAS</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">InterlockedCompareExchange(__inout LONG <span style="color:#8b008b;font-weight:bold">volatile</span>  *Target, __in LONG Exchange, __in LONG Comperand);
</code></pre></div></li>
<li>
<p>C++11标准库的CAS</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">template&lt; class T &gt;
<span style="color:#00688b;font-weight:bold">bool</span> atomic_compare_exchange_weak(std::atomic&lt;T&gt;* obj, T* expected, T desired);
template&lt; class T &gt;
<span style="color:#00688b;font-weight:bold">bool</span> atomic_compare_exchange_weak(<span style="color:#8b008b;font-weight:bold">volatile</span> std::atomic&lt;T&gt;* obj, T* expected, T desired );
</code></pre></div></li>
</ul>
<h4 id="22-无锁队列">2.2 无锁队列</h4>
<ul>
<li>
<p><a href="https://github.com/gongluck/CVIP/blob/master/code/cas/cas.h">无锁队列代码</a></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#228b22">/*
</span><span style="color:#228b22"> * @Author: gongluck 
</span><span style="color:#228b22"> * @Date: 2020-11-16 16:02:56 
</span><span style="color:#228b22"> * @Last Modified by:   gongluck 
</span><span style="color:#228b22"> * @Last Modified time: 2020-11-16 16:02:56 
</span><span style="color:#228b22"> */</span>
  
template &lt;<span style="color:#8b008b;font-weight:bold">typename</span> ElemType&gt;
class Queue
{
public:
    Queue();
    ~Queue();
  
public:
    <span style="color:#00688b;font-weight:bold">void</span> push(ElemType elem);
    <span style="color:#00688b;font-weight:bold">bool</span> <span style="color:#008b45">pop</span>();
    <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">show</span>();
  
private:
    <span style="color:#8b008b;font-weight:bold">struct</span> _qNode
    {
        _qNode() : _next(nullptr) {}
        _qNode(ElemType elem) : _elem(elem), _next(nullptr) {}
        ElemType _elem;
        <span style="color:#8b008b;font-weight:bold">struct</span> _qNode *_next;
    };
  
private:
    <span style="color:#8b008b;font-weight:bold">struct</span> _qNode *_head;
    <span style="color:#8b008b;font-weight:bold">struct</span> _qNode *_tail;
};
  
template &lt;<span style="color:#8b008b;font-weight:bold">typename</span> ElemType&gt;
Queue&lt;ElemType&gt;::Queue()
{
    _head = _tail = new _qNode();
}
  
template &lt;<span style="color:#8b008b;font-weight:bold">typename</span> ElemType&gt;
Queue&lt;ElemType&gt;::~Queue()
{
    <span style="color:#8b008b;font-weight:bold">while</span> (_head != nullptr)
    {
        <span style="color:#8b008b;font-weight:bold">struct</span> _qNode *tempNode = _head;
        _head = _head-&gt;_next;
        delete tempNode;
    }
}
  
template &lt;<span style="color:#8b008b;font-weight:bold">typename</span> ElemType&gt;
<span style="color:#00688b;font-weight:bold">void</span> Queue&lt;ElemType&gt;::push(ElemType elem)
{
    <span style="color:#8b008b;font-weight:bold">struct</span> _qNode *newNode = new <span style="color:#8b008b;font-weight:bold">struct</span> _qNode(elem);
    <span style="color:#8b008b;font-weight:bold">struct</span> _qNode *oldp = _tail;
    <span style="color:#8b008b;font-weight:bold">while</span> (!__sync_bool_compare_and_swap(&amp;_tail-&gt;_next, nullptr, newNode))
        ;
    __sync_bool_compare_and_swap(&amp;_tail, oldp, newNode);
}
  
template &lt;<span style="color:#8b008b;font-weight:bold">typename</span> ElemType&gt;
<span style="color:#00688b;font-weight:bold">bool</span> Queue&lt;ElemType&gt;::pop()
{
    <span style="color:#8b008b;font-weight:bold">struct</span> _qNode *p;
    <span style="color:#8b008b;font-weight:bold">do</span>
    {
        p = _head;
        <span style="color:#8b008b;font-weight:bold">if</span> (p-&gt;_next == nullptr)
            <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#658b00">false</span>;
    } <span style="color:#8b008b;font-weight:bold">while</span> (!__sync_bool_compare_and_swap(&amp;_head, p, p-&gt;_next));
    delete p;
    <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#658b00">true</span>;
}
</code></pre></div><!-- raw HTML omitted -->
</li>
</ul>
<h3 id="3内存池">3.内存池</h3>
<h4 id="31-nginx内存池结构">3.1 Nginx内存池结构</h4>
<ul>
<li>
<p>Nginx内存池结构</p>
<p><img src="https://github.com/gongluck/CVIP/blob/master/images/Nginx%E5%86%85%E5%AD%98%E6%B1%A0%E7%BB%93%E6%9E%84.jpg?raw=true" alt="Nginx内存池结构"></p>
</li>
<li>
<p>nginx对内存的管理分为大内存与小内存，当某一个申请的内存大于某一个值时，就需要从大内存中分配空间，否则从小内存中分配空间。</p>
</li>
<li>
<p>nginx中的内存池是在创建的时候就设定好了大小，在以后分配小块内存的时候，如果内存不够，则是重新创建一块内存串到内存池中，而不是将原有的内存池进行扩张。当要分配大块内存是，则是在内存池外面再分配空间进行管理的，称为大块内存池。</p>
</li>
<li>
<p>Nginx内存池中大内存块和小内存块的分配与释放是不一样的。使用内存池时，可以使用ngx_palloc进行分配，使用ngx_pfree释放。对于大内存，这样做是没有问题的，而对于小内存就不一样了，分配的小内存，不会进行释放。</p>
</li>
</ul>
<h4 id="32-nginx内存池的实现httpsgithubcomgongluckcvipblobmastercodemmpoolngx_pallocc">3.2 <a href="https://github.com/gongluck/CVIP/blob/master/code/mmpool/ngx_palloc.c">Nginx内存池的实现</a></h4>
<!-- raw HTML omitted -->
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">ngx_pool_t *
<span style="color:#008b45">ngx_create_pool</span>(size_t size, ngx_log_t *log)
{
    ngx_pool_t  *p;

    p = ngx_memalign(NGX_POOL_ALIGNMENT, size, log);
    <span style="color:#8b008b;font-weight:bold">if</span> (p == <span style="color:#658b00">NULL</span>) {
        <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#658b00">NULL</span>;
    }

    p-&gt;d.last = (u_char *) p + <span style="color:#8b008b;font-weight:bold">sizeof</span>(ngx_pool_t);<span style="color:#228b22">//初始状态：last指向ngx_pool_t结构体之后数据取起始位置
</span><span style="color:#228b22"></span>    p-&gt;d.end = (u_char *) p + size;<span style="color:#228b22">//end指向分配的整个size大小的内存的末尾
</span><span style="color:#228b22"></span>    p-&gt;d.next = <span style="color:#658b00">NULL</span>;
    p-&gt;d.failed = <span style="color:#b452cd">0</span>;

    size = size - <span style="color:#8b008b;font-weight:bold">sizeof</span>(ngx_pool_t);
    p-&gt;max = (size &lt; NGX_MAX_ALLOC_FROM_POOL) ? size : NGX_MAX_ALLOC_FROM_POOL;

    p-&gt;current = p;
    p-&gt;chain = <span style="color:#658b00">NULL</span>;
    p-&gt;large = <span style="color:#658b00">NULL</span>;
    p-&gt;cleanup = <span style="color:#658b00">NULL</span>;
    p-&gt;log = log;

    <span style="color:#8b008b;font-weight:bold">return</span> p;
}


<span style="color:#00688b;font-weight:bold">void</span>
<span style="color:#008b45">ngx_destroy_pool</span>(ngx_pool_t *pool)
{
    ngx_pool_t          *p, *n;
    ngx_pool_large_t    *l;
    ngx_pool_cleanup_t  *c;

    <span style="color:#228b22">//首先调用所有的数据清理函数
</span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">for</span> (c = pool-&gt;cleanup; c; c = c-&gt;next) {
        <span style="color:#8b008b;font-weight:bold">if</span> (c-&gt;handler) {
            ngx_log_debug1(NGX_LOG_DEBUG_ALLOC, pool-&gt;log, <span style="color:#b452cd">0</span>,
                           <span style="color:#cd5555">&#34;run cleanup: %p&#34;</span>, c);
            c-&gt;handler(c-&gt;data);
        }
    }

<span style="color:#1e889b">#if (NGX_DEBUG)
</span><span style="color:#1e889b"></span>
    <span style="color:#228b22">/*
</span><span style="color:#228b22">     * we could allocate the pool-&gt;log from this pool
</span><span style="color:#228b22">     * so we cannot use this log while free()ing the pool
</span><span style="color:#228b22">     */</span>

    <span style="color:#8b008b;font-weight:bold">for</span> (l = pool-&gt;large; l; l = l-&gt;next) {
        ngx_log_debug1(NGX_LOG_DEBUG_ALLOC, pool-&gt;log, <span style="color:#b452cd">0</span>, <span style="color:#cd5555">&#34;free: %p&#34;</span>, l-&gt;alloc);
    }

    <span style="color:#8b008b;font-weight:bold">for</span> (p = pool, n = pool-&gt;d.next; <span style="color:#228b22">/* void */</span>; p = n, n = n-&gt;d.next) {
        ngx_log_debug2(NGX_LOG_DEBUG_ALLOC, pool-&gt;log, <span style="color:#b452cd">0</span>,
                       <span style="color:#cd5555">&#34;free: %p, unused: %uz&#34;</span>, p, p-&gt;d.end - p-&gt;d.last);

        <span style="color:#8b008b;font-weight:bold">if</span> (n == <span style="color:#658b00">NULL</span>) {
            <span style="color:#8b008b;font-weight:bold">break</span>;
        }
    }

<span style="color:#1e889b">#endif
</span><span style="color:#1e889b"></span>
    <span style="color:#228b22">//释放所有的大块内存
</span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">for</span> (l = pool-&gt;large; l; l = l-&gt;next) {
        <span style="color:#8b008b;font-weight:bold">if</span> (l-&gt;alloc) {
            ngx_free(l-&gt;alloc);
        }
    }

    <span style="color:#228b22">//最后释放所有内存池中的内存块
</span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">for</span> (p = pool, n = pool-&gt;d.next; <span style="color:#228b22">/* void */</span>; p = n, n = n-&gt;d.next) {
        ngx_free(p);

        <span style="color:#8b008b;font-weight:bold">if</span> (n == <span style="color:#658b00">NULL</span>) {
            <span style="color:#8b008b;font-weight:bold">break</span>;
        }
    }
}


<span style="color:#00688b;font-weight:bold">void</span>
<span style="color:#008b45">ngx_reset_pool</span>(ngx_pool_t *pool)
{
    ngx_pool_t        *p;
    ngx_pool_large_t  *l;

    <span style="color:#228b22">//释放所有大块内存
</span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">for</span> (l = pool-&gt;large; l; l = l-&gt;next) {
        <span style="color:#8b008b;font-weight:bold">if</span> (l-&gt;alloc) {
            ngx_free(l-&gt;alloc);
        }
    }

    <span style="color:#228b22">//重置所有小块内存区
</span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">for</span> (p = pool; p; p = p-&gt;d.next) {
        p-&gt;d.last = (u_char *) p + <span style="color:#8b008b;font-weight:bold">sizeof</span>(ngx_pool_t);
        p-&gt;d.failed = <span style="color:#b452cd">0</span>;
    }

    pool-&gt;current = pool;
    pool-&gt;chain = <span style="color:#658b00">NULL</span>;
    pool-&gt;large = <span style="color:#658b00">NULL</span>;
}


<span style="color:#00688b;font-weight:bold">void</span> *
<span style="color:#008b45">ngx_palloc</span>(ngx_pool_t *pool, size_t size)
{
<span style="color:#1e889b">#if !(NGX_DEBUG_PALLOC)
</span><span style="color:#1e889b"></span>    <span style="color:#8b008b;font-weight:bold">if</span> (size &lt;= pool-&gt;max) {
        <span style="color:#8b008b;font-weight:bold">return</span> ngx_palloc_small(pool, size, <span style="color:#b452cd">1</span>);
    }
<span style="color:#1e889b">#endif
</span><span style="color:#1e889b"></span>
    <span style="color:#8b008b;font-weight:bold">return</span> ngx_palloc_large(pool, size);
}


<span style="color:#00688b;font-weight:bold">void</span> *
<span style="color:#008b45">ngx_pnalloc</span>(ngx_pool_t *pool, size_t size)
{
<span style="color:#1e889b">#if !(NGX_DEBUG_PALLOC)
</span><span style="color:#1e889b"></span>    <span style="color:#8b008b;font-weight:bold">if</span> (size &lt;= pool-&gt;max) {
        <span style="color:#8b008b;font-weight:bold">return</span> ngx_palloc_small(pool, size, <span style="color:#b452cd">0</span>);
    }
<span style="color:#1e889b">#endif
</span><span style="color:#1e889b"></span>
    <span style="color:#8b008b;font-weight:bold">return</span> ngx_palloc_large(pool, size);
}


<span style="color:#8b008b;font-weight:bold">static</span> ngx_inline <span style="color:#00688b;font-weight:bold">void</span> *
<span style="color:#008b45">ngx_palloc_small</span>(ngx_pool_t *pool, size_t size, ngx_uint_t align)
{
    u_char      *m;
    ngx_pool_t  *p;

    p = pool-&gt;current;

    <span style="color:#8b008b;font-weight:bold">do</span> {
        m = p-&gt;d.last;

        <span style="color:#8b008b;font-weight:bold">if</span> (align) {
            m = ngx_align_ptr(m, NGX_ALIGNMENT);
        }

        <span style="color:#8b008b;font-weight:bold">if</span> ((size_t) (p-&gt;d.end - m) &gt;= size) {<span style="color:#228b22">//如果在当前内存块有效范围内，进行内存指针的移动
</span><span style="color:#228b22"></span>            p-&gt;d.last = m + size;

            <span style="color:#8b008b;font-weight:bold">return</span> m;
        }

        p = p-&gt;d.next;<span style="color:#228b22">//如果当前内存块有效容量不够分配，则移动到下一个内存块进行分配
</span><span style="color:#228b22"></span>
    } <span style="color:#8b008b;font-weight:bold">while</span> (p);

    <span style="color:#8b008b;font-weight:bold">return</span> ngx_palloc_block(pool, size);
}


<span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">void</span> *
<span style="color:#008b45">ngx_palloc_block</span>(ngx_pool_t *pool, size_t size)
{
    u_char      *m;
    size_t       psize;
    ngx_pool_t  *p, *new;

    psize = (size_t) (pool-&gt;d.end - (u_char *) pool);<span style="color:#228b22">//计算内存池第一个内存块的大小
</span><span style="color:#228b22"></span>
    m = ngx_memalign(NGX_POOL_ALIGNMENT, psize, pool-&gt;log);<span style="color:#228b22">//分配和第一个内存块同样大小的内存块
</span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">if</span> (m == <span style="color:#658b00">NULL</span>) {
        <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#658b00">NULL</span>;
    }

    new = (ngx_pool_t *) m;

    new-&gt;d.end = m + psize;<span style="color:#228b22">//设置新内存块的end
</span><span style="color:#228b22"></span>    new-&gt;d.next = <span style="color:#658b00">NULL</span>;
    new-&gt;d.failed = <span style="color:#b452cd">0</span>;

    m += <span style="color:#8b008b;font-weight:bold">sizeof</span>(ngx_pool_data_t);<span style="color:#228b22">//将指针m移动到d后面的一个位置，作为起始位置
</span><span style="color:#228b22"></span>    m = ngx_align_ptr(m, NGX_ALIGNMENT);
    new-&gt;d.last = m + size;<span style="color:#228b22">//设置新内存块的last，即申请使用size大小的内存
</span><span style="color:#228b22"></span>
    <span style="color:#228b22">//这里的循环用来找最后一个链表节点，这里failed用来控制循环的长度，如果分配失败次数达到5次，就忽略，不需要每次都从头找起
</span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">for</span> (p = pool-&gt;current; p-&gt;d.next; p = p-&gt;d.next) {
        <span style="color:#8b008b;font-weight:bold">if</span> (p-&gt;d.failed++ &gt; <span style="color:#b452cd">4</span>) {
            pool-&gt;current = p-&gt;d.next;
        }
    }

    p-&gt;d.next = new;

    <span style="color:#8b008b;font-weight:bold">return</span> m;
}


<span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">void</span> *
<span style="color:#008b45">ngx_palloc_large</span>(ngx_pool_t *pool, size_t size)
{
    <span style="color:#00688b;font-weight:bold">void</span>              *p;
    ngx_uint_t         n;
    ngx_pool_large_t  *large;

    <span style="color:#228b22">//直接在系统堆中分配一块空间
</span><span style="color:#228b22"></span>    p = ngx_alloc(size, pool-&gt;log);
    <span style="color:#8b008b;font-weight:bold">if</span> (p == <span style="color:#658b00">NULL</span>) {
        <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#658b00">NULL</span>;
    }

    n = <span style="color:#b452cd">0</span>;
    <span style="color:#228b22">//查找到一个空的large区，如果有，则将刚才分配的空间交由它管理
</span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">for</span> (large = pool-&gt;large; large; large = large-&gt;next) {
        <span style="color:#8b008b;font-weight:bold">if</span> (large-&gt;alloc == <span style="color:#658b00">NULL</span>) {
            large-&gt;alloc = p;
            <span style="color:#8b008b;font-weight:bold">return</span> p;
        }

        <span style="color:#8b008b;font-weight:bold">if</span> (n++ &gt; <span style="color:#b452cd">3</span>) {
            <span style="color:#8b008b;font-weight:bold">break</span>;
        }
    }

    <span style="color:#228b22">//为了提高效率， 如果在三次内没有找到空的large结构体，则创建一个
</span><span style="color:#228b22"></span>    large = ngx_palloc_small(pool, <span style="color:#8b008b;font-weight:bold">sizeof</span>(ngx_pool_large_t), <span style="color:#b452cd">1</span>);
    <span style="color:#8b008b;font-weight:bold">if</span> (large == <span style="color:#658b00">NULL</span>) {
        ngx_free(p);
        <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#658b00">NULL</span>;
    }

    large-&gt;alloc = p;
    large-&gt;next = pool-&gt;large;
    pool-&gt;large = large;

    <span style="color:#8b008b;font-weight:bold">return</span> p;
}


<span style="color:#00688b;font-weight:bold">void</span> *
<span style="color:#008b45">ngx_pmemalign</span>(ngx_pool_t *pool, size_t size, size_t alignment)
{
    <span style="color:#00688b;font-weight:bold">void</span>              *p;
    ngx_pool_large_t  *large;

    p = ngx_memalign(alignment, size, pool-&gt;log);
    <span style="color:#8b008b;font-weight:bold">if</span> (p == <span style="color:#658b00">NULL</span>) {
        <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#658b00">NULL</span>;
    }

    large = ngx_palloc_small(pool, <span style="color:#8b008b;font-weight:bold">sizeof</span>(ngx_pool_large_t), <span style="color:#b452cd">1</span>);
    <span style="color:#8b008b;font-weight:bold">if</span> (large == <span style="color:#658b00">NULL</span>) {
        ngx_free(p);
        <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#658b00">NULL</span>;
    }

    large-&gt;alloc = p;
    large-&gt;next = pool-&gt;large;
    pool-&gt;large = large;

    <span style="color:#8b008b;font-weight:bold">return</span> p;
}


ngx_int_t
<span style="color:#008b45">ngx_pfree</span>(ngx_pool_t *pool, <span style="color:#00688b;font-weight:bold">void</span> *p)
{
    ngx_pool_large_t  *l;

    <span style="color:#228b22">//只检查是否是大内存块，如果是大内存块则释放
</span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">for</span> (l = pool-&gt;large; l; l = l-&gt;next) {
        <span style="color:#8b008b;font-weight:bold">if</span> (p == l-&gt;alloc) {
            ngx_log_debug1(NGX_LOG_DEBUG_ALLOC, pool-&gt;log, <span style="color:#b452cd">0</span>,
                           <span style="color:#cd5555">&#34;free: %p&#34;</span>, l-&gt;alloc);
            ngx_free(l-&gt;alloc);
            l-&gt;alloc = <span style="color:#658b00">NULL</span>;

            <span style="color:#8b008b;font-weight:bold">return</span> NGX_OK;
        }
    }

    <span style="color:#8b008b;font-weight:bold">return</span> NGX_DECLINED;
}
</code></pre></div><!-- raw HTML omitted -->

                    
                    <HR width="100%" id="EOF">
                    <p style="color:#777;">Last modified on 2020-11-30</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="https://gongluck.github.io/linux/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6%E4%B8%93%E9%A2%98/">
                    Next<br>开源框架专题
                </a>
                
                
                
                <a class="older-posts" href="https://gongluck.github.io/linux/%E5%90%8E%E5%8F%B0%E7%BB%84%E4%BB%B6%E7%BC%96%E7%A8%8B%E4%B8%93%E6%A0%8F/">
                    Previous<br>后台组件编程专栏
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                


<div id="gitalk-container"></div>





            </div>
        </div>
    </div>
</div>

            </div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2024 gongluck&#39;s blog
	</div>
            </div>
    <script>
let app;

app = new Vue({
    el: '#app',
    data: {
        scrollY: 0,
        navOpacity: 0,
        isDrawerOpen: false,
        mounted: false,
        isDarkMode: false
    },
    methods: {
            sgn(t, x) {
                let k = 1. / (1. - 2 * t);
                if (x <= t) return 0;
                else if (x >= 1 - t) return 1;
                else {
                    return k * (x - t);
                }
            },
            handleScroll() {
                this.scrollY = window.scrollY;
                this.navOpacity = this.sgn(.0, Math.min(1, Math.max(0, window.scrollY / (this.pageHeadHeight() - this.navBarHeight() * 0.8))));
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;

                if (this.navOpacity >= 1) {
                    navBackground.style.opacity = 1;
                    navTitle.style.opacity = 1;
                } else {
                    navBackground.style.opacity = 0;
                    navTitle.style.opacity = 0;
                }
            },
            handleResize() {
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;
                extraContainer.style.left = (streamContainer.offsetWidth - extraContainer.offsetWidth) + 'px';
            },
            navBarHeight() {
                return this.$refs.navBar.offsetHeight;
            },
            pageHeadHeight() {
                return this.$refs.pageHead.offsetHeight;
            },
            toggleDrawer() {
                this.isDrawerOpen = !this.isDrawerOpen;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            closeDrawer() {
                this.isDrawerOpen = false;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            toggleDarkMode() {
                this.isDarkMode = !this.isDarkMode;
                if (this.isDarkMode==true){
                    document.cookie = "night=1;path=/";
                    document.body.classList.add("night");
                } else {
                    document.cookie = "night=0;path=/";
                    document.body.classList.remove("night");
                }
            }
    },
    created() {
        window.addEventListener('scroll', this.handleScroll);
        window.addEventListener('resize', this.handleResize);
        window._nonDesktop = function () {
            let check = false;
            (function (a) {
                if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true;
            })(navigator.userAgent || navigator.vendor || window.opera);
            return check;
        };
        
        var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        if (night==""){
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                
            }
        }else{
            
            if (night=="1") {
                this.toggleDarkMode();
            }
        }
    },
    mounted() {
        this.handleScroll();
        this.handleResize();
        this.mounted = true;
        
    },
    destroyed() {
        window.removeEventListener('scroll', this.handleScroll);
        window.removeEventListener('resize', this.handleResize);
    }
});
</script>

<script src="https://gongluck.github.io/js/journal.js"></script>
    </body>
</html>
